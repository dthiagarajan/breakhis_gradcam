---

title: BreaKHis Data Processing

keywords: fastai
sidebar: home_sidebar

summary: "The BreaKHis dataset is organized by benign and malignant tumors, and then by the specific tumor types. The functions provided here will help to quickly (lazily) process the data for usage in training image classification models, while maintaining the additional information that might not be necessary. For example, if training on benign/malignant labels, the information about which specific tumor is present will still be available in the dataset definition. The data is anonymized, so there's no possibility of splitting at the patient level. Instead, we leave dataset splitting up to the user, but provide some utility functions to reproduce the results obtained in initial development."
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 01_data.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
    
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>For reproducibility, the random seed (for both Numpy and PyTorch) are set to 31.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="BreaKHisDataset" class="doc_header"><code>class</code> <code>BreaKHisDataset</code><a href="https://github.com/dthiagarajan/breakhis_gradcam/tree/master/breakhis_gradcam/data.py#L17" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>BreaKHisDataset</code>(<strong><code>dataset</code></strong>, <strong><code>transform</code></strong>=<em><code>None</code></em>) :: <code>Dataset</code></p>
</blockquote>
<p>PyTorch dataset definition of the BreaKHis dataset.</p>
<p>Construction of the dataset object should be done using this
class's method <code>initialize</code>. Simply providing the data directory
where the data was downloaded is sufficient.</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="initialize_datasets" class="doc_header"><code>initialize_datasets</code><a href="https://github.com/dthiagarajan/breakhis_gradcam/tree/master/breakhis_gradcam/data.py#L229" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>initialize_datasets</code>(<strong><code>data_dir</code></strong>, <strong><code>label</code></strong>=<em><code>'tumor_class'</code></em>, <strong><code>split</code></strong>=<em><code>{'train': 0.8, 'val': 0.2}</code></em>, <strong><code>criterion</code></strong>=<em><code>['tumor_class']</code></em>, <strong><code>split_transforms</code></strong>=<em><code>{'train': None, 'val': None}</code></em>)</p>
</blockquote>
<p>Returns a <a href="/breakhis_gradcam/data#BreaKHisDataset"><code>BreaKHisDataset</code></a> object for the data contained in <code>data_dir</code>.</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>To create the dataset, you only need one function calls. Within this function call:</p>
<ul>
<li>You can specify the label type when initializing the dataset by specifying <code>label</code> in <code>initialize</code><ul>
<li>It must be 1 of 'tumor_class' or 'tumor_type'</li>
</ul>
</li>
<li>You can make arbitrary splits of the data (within reason) when splitting the dataset via <code>split_dataset</code></li>
<li>You can make sure to split equally within various criterion using <code>criterion</code>, which can include tumor class/tumor type, and magnification.<ul>
<li>You can not split equally by both tumor class and tumor type (error will be thrown if attempted).</li>
</ul>
</li>
<li>You can use different transforms for different splits using <code>split_transforms</code>.</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">train_transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
    <span class="n">transforms</span><span class="o">.</span><span class="n">RandomRotation</span><span class="p">(</span><span class="mi">90</span><span class="p">),</span>
    <span class="n">transforms</span><span class="o">.</span><span class="n">RandomHorizontalFlip</span><span class="p">(</span><span class="mf">0.8</span><span class="p">),</span>
    <span class="n">transforms</span><span class="o">.</span><span class="n">RandomResizedCrop</span><span class="p">(</span><span class="mi">224</span><span class="p">),</span>
    <span class="n">transforms</span><span class="o">.</span><span class="n">ColorJitter</span><span class="p">(</span><span class="n">brightness</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">contrast</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">saturation</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="mf">0.1</span><span class="p">),</span>
    <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
    <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">((</span><span class="mf">0.4914</span><span class="p">,</span> <span class="mf">0.4822</span><span class="p">,</span> <span class="mf">0.4465</span><span class="p">),</span>
                         <span class="p">(</span><span class="mf">0.2023</span><span class="p">,</span> <span class="mf">0.1994</span><span class="p">,</span> <span class="mf">0.2010</span><span class="p">)),</span>
<span class="p">])</span>

<span class="n">val_transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
    <span class="n">transforms</span><span class="o">.</span><span class="n">CenterCrop</span><span class="p">(</span><span class="mi">224</span><span class="p">),</span>
    <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
    <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">((</span><span class="mf">0.4914</span><span class="p">,</span> <span class="mf">0.4822</span><span class="p">,</span> <span class="mf">0.4465</span><span class="p">),</span>
                        <span class="p">(</span><span class="mf">0.2023</span><span class="p">,</span> <span class="mf">0.1994</span><span class="p">,</span> <span class="mf">0.2010</span><span class="p">)),</span>
<span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ds_mapping</span> <span class="o">=</span> <span class="n">initialize_datasets</span><span class="p">(</span>
    <span class="s1">&#39;/share/nikola/export/dt372/BreaKHis_v1/&#39;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s1">&#39;tumor_type&#39;</span><span class="p">,</span> <span class="n">criterion</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;tumor_type&#39;</span><span class="p">,</span> <span class="s1">&#39;magnification&#39;</span><span class="p">],</span>
    <span class="n">split_transforms</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;train&#39;</span><span class="p">:</span> <span class="n">train_transform</span><span class="p">,</span> <span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="n">val_transform</span><span class="p">}</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tr_ds</span><span class="p">,</span> <span class="n">val_ds</span> <span class="o">=</span> <span class="n">ds_mapping</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">],</span> <span class="n">ds_mapping</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tr_ds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(tensor([[[-2.4291, -2.4291, -2.4291,  ...,  0.8082,  0.7888,  0.8082],
          [-2.4291, -2.4291, -2.4291,  ...,  0.8082,  0.7888,  0.7888],
          [-2.4291, -2.4291, -2.4291,  ...,  0.8082,  0.8082,  0.7501],
          ...,
          [ 0.6725,  0.6144,  0.2654,  ...,  0.4399,  0.3624,  0.0522],
          [ 0.4981,  0.6338,  0.5174,  ...,  0.3236,  0.3817,  0.1297],
          [ 0.3430,  0.3624,  0.4593,  ...,  0.3624,  0.3042,  0.0522]],
 
         [[-2.4183, -2.4183, -2.4183,  ...,  0.9251,  0.9251,  0.9251],
          [-2.4183, -2.4183, -2.4183,  ...,  0.9251,  0.9054,  0.9251],
          [-2.4183, -2.4183, -2.4183,  ...,  0.9251,  0.9251,  0.9054],
          ...,
          [ 0.2564,  0.2564, -0.0189,  ...,  0.5121,  0.4531,  0.0598],
          [ 0.0598,  0.1778,  0.1581,  ...,  0.3744,  0.4138,  0.1188],
          [-0.1566, -0.0976,  0.0204,  ...,  0.4531,  0.3548,  0.0991]],
 
         [[-2.2214, -2.2214, -2.2214,  ...,  0.8027,  0.8027,  0.8027],
          [-2.2214, -2.2214, -2.2214,  ...,  0.7832,  0.7637,  0.7832],
          [-2.2214, -2.2214, -2.2214,  ...,  0.8027,  0.7832,  0.7832],
          ...,
          [ 1.0368,  0.9978,  0.7052,  ...,  0.9588,  0.9588,  0.6661],
          [ 0.8807,  0.9978,  0.9198,  ...,  0.8807,  0.9783,  0.8027],
          [ 0.7442,  0.8027,  0.8612,  ...,  0.9588,  0.9588,  0.7637]]]),
 tensor(0))</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>From here, it is very simple to create the dataloaders for use in training.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tr_dl</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">tr_ds</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">val_dl</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">val_ds</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">tr_dl</span><span class="p">))</span>
<span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(torch.Size([32, 3, 224, 224]), torch.Size([32]))</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Appendix">Appendix<a class="anchor-link" href="#Appendix">&#182;</a></h2><p>All images in this dataset are captured from an ROI determined by a professional pathologist, so all images are assumed to have <em>a</em> tumor.</p>
<h3 id="Samples">Samples<a class="anchor-link" href="#Samples">&#182;</a></h3><ul>
<li>Samples are generated from breast tissue biopsy slides, stained with hematoxylin and eosin (HE).</li>
<li>Prepared for histological study and labelled by pathologists of the P&amp;D Lab</li>
<li>Breast tumor specimens assessed by Immunohistochemistry (IHC)</li>
<li>Core Needle Biopsy (CNB) and Surgical Open Biopsy (SOB)</li>
<li>Section of ~3µm thickness</li>
</ul>
<h3 id="Image-acquisition">Image acquisition<a class="anchor-link" href="#Image-acquisition">&#182;</a></h3><ul>
<li>Olympus BX-50 system microscope with a relay lens with magnification of 3.3× coupled to a Samsung digital color camera SCC-131AN</li>
<li>Magnification 40×, 100×, 200×, and 400× (objective lens 4×, 10×, 20×, and 40× with ocular lens 10×)</li>
<li>Camera pixel size 6.5 µm</li>
<li>Raw images without normalization nor color color standardization</li>
<li>Resulting images saved in 3-channel RGB, 8-bit depth in each channel, PNG format</li>
</ul>

</div>
</div>
</div>
</div>
 

